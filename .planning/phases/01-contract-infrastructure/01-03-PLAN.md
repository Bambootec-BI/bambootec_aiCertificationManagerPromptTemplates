---
phase: 01-contract-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - custom_gpt_instructions.json
  - skill_tree_builder_template.json
  - skill_tree_to_content_tree_template.json
  - skill_to_practice_exercises_template.json
  - skill_to_evaluation_exam_template.json
autonomous: true

must_haves:
  truths:
    - "format_standards is embedded in custom_gpt_instructions.json with version marker"
    - "Each template has contract_versions in meta section with input_expects and output_produces"
    - "Version markers use semantic versioning pattern"
  artifacts:
    - path: "custom_gpt_instructions.json"
      provides: "Router with embedded format_standards"
      contains: "format_standards, version"
    - path: "skill_tree_builder_template.json"
      provides: "Template with contract_versions"
      contains: "contract_versions, output_produces"
    - path: "skill_tree_to_content_tree_template.json"
      provides: "Template with contract_versions"
      contains: "contract_versions, input_expects, output_produces"
    - path: "skill_to_practice_exercises_template.json"
      provides: "Template with contract_versions"
      contains: "contract_versions, input_expects, output_produces"
    - path: "skill_to_evaluation_exam_template.json"
      provides: "Template with contract_versions"
      contains: "contract_versions, input_expects"
  key_links:
    - from: "skill_tree_to_content_tree_template.json"
      to: "skill_tree_builder_template.json"
      via: "input_expects.skill_tree"
      pattern: "skill_tree_builder@"
    - from: "skill_to_practice_exercises_template.json"
      to: "skill_tree_to_content_tree_template.json"
      via: "input_expects.content_summary"
      pattern: "skill_tree_to_content@"
    - from: "skill_to_evaluation_exam_template.json"
      to: "multiple upstream templates"
      via: "input_expects"
      pattern: "input_expects"
---

<objective>
Update existing templates with version markers and embed format_standards in router.

Purpose: Enable version drift detection between templates and centralize format rules for single source of truth
Output: 5 modified JSON template files with contract_versions
</objective>

<execution_context>
@/Users/bambootec/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bambootec/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contract-infrastructure/01-RESEARCH.md
@.planning/phases/01-contract-infrastructure/01-01-SUMMARY.md
@schemas/shared/format_standards.schema.json
@schemas/shared/contract_versions.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Embed format_standards in router (custom_gpt_instructions.json)</name>
  <files>custom_gpt_instructions.json</files>
  <action>
Read custom_gpt_instructions.json and add a format_standards section based on the schema.

Add at top level (sibling to main_instruction):
```json
"format_standards": {
  "version": "1.0.0",
  "indentation": {
    "use_spaces_only": true,
    "spaces_per_level": 2,
    "tabs_forbidden": true
  },
  "list_style": {
    "all_levels": "-"
  },
  "language_policy": {
    "instruction_language": "English",
    "output_language": "Spanish",
    "exceptions": ["proper_names", "commonly_used_names", "code_blocks", "technical_terms"]
  },
  "link_format": {
    "preferred": "raw_url_own_line",
    "fallback": "[URL](URL)",
    "forbidden": ["code_blocks", "search_queries", "invented_urls"]
  }
}
```

This consolidates the formatting rules already scattered in global_rules.formatting_policy.

Also update global_rules.formatting_policy to reference format_standards:
- Add "_ref": "See format_standards section for canonical definitions"
- Keep existing rules but they now serve as documentation/reminders pointing to the source of truth
  </action>
  <verify>
```bash
cat custom_gpt_instructions.json | jq '.format_standards.version'  # Should output "1.0.0"
```
  </verify>
  <done>
custom_gpt_instructions.json has format_standards section with version 1.0.0 containing indentation, list_style, language_policy, and link_format definitions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add contract_versions to all 4 generation templates</name>
  <files>
    skill_tree_builder_template.json
    skill_tree_to_content_tree_template.json
    skill_to_practice_exercises_template.json
    skill_to_evaluation_exam_template.json
  </files>
  <action>
For each template, add contract_versions inside the meta section (or create meta if missing):

1. skill_tree_builder_template.json:
   - Update meta.version to "1.2.0" (normalize to semver)
   - Add contract_versions:
     ```json
     "contract_versions": {
       "format_standards": "1.0.0",
       "input_expects": {},
       "output_produces": {
         "skill_tree": "1.2.0"
       }
     }
     ```

2. skill_tree_to_content_tree_template.json:
   - Normalize template_version to meta.version = "1.7.0" (strip descriptive suffix)
   - Add meta section with name and version if not present
   - Add contract_versions:
     ```json
     "contract_versions": {
       "format_standards": "1.0.0",
       "input_expects": {
         "skill_tree": "skill_tree_builder@1.2.0"
       },
       "output_produces": {
         "content_tree": "1.7.0",
         "content_summary": "1.0.0"
       }
     }
     ```

3. skill_to_practice_exercises_template.json:
   - Read template to find current version
   - Add/update meta with name and normalized version
   - Add contract_versions:
     ```json
     "contract_versions": {
       "format_standards": "1.0.0",
       "input_expects": {
         "content_summary": "skill_tree_to_content@1.0.0"
       },
       "output_produces": {
         "exercise_tree": "VERSION",
         "exercise_summary": "1.0.0"
       }
     }
     ```

4. skill_to_evaluation_exam_template.json:
   - Read template to find current version
   - Add/update meta with name and normalized version
   - Add contract_versions:
     ```json
     "contract_versions": {
       "format_standards": "1.0.0",
       "input_expects": {
         "content_summary": "skill_tree_to_content@1.0.0",
         "exercise_summary": "skill_to_practice_exercises@1.0.0"
       },
       "output_produces": {
         "exam": "VERSION",
         "evaluation_guide": "VERSION"
       }
     }
     ```

IMPORTANT:
- Preserve all existing template content
- Only add/modify the meta and contract_versions sections
- Use actual version numbers from template files where available
  </action>
  <verify>
```bash
for f in skill_tree_builder_template.json skill_tree_to_content_tree_template.json skill_to_practice_exercises_template.json skill_to_evaluation_exam_template.json; do
  echo "=== $f ==="
  cat "$f" | jq '.meta.contract_versions // .contract_versions // "NOT FOUND"'
done
```
  </verify>
  <done>
All 4 generation templates have contract_versions with:
- format_standards version reference
- input_expects listing upstream dependencies
- output_produces listing what they generate
  </done>
</task>

</tasks>

<verification>
1. custom_gpt_instructions.json has format_standards section with version 1.0.0
2. All 4 generation templates have contract_versions in meta section
3. Version chain is complete: skill_tree_builder -> skill_tree_to_content -> skill_to_practice_exercises -> skill_to_evaluation_exam
4. All templates are still valid JSON after modifications
5. Running scripts/check_versions.sh shows the version relationships
</verification>

<success_criteria>
- format_standards embedded in router with version 1.0.0
- All templates have contract_versions with input_expects and output_produces
- Version markers use semantic versioning pattern (X.Y.Z)
- Handoff contracts are explicit: downstream knows exactly what version it expects from upstream
</success_criteria>

<output>
After completion, create `.planning/phases/01-contract-infrastructure/01-03-SUMMARY.md`
</output>
